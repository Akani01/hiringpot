<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification Preferences - JobPortal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        .header-area {
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 999;
        }
        .main-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
        }
        .logo img {
            max-height: 40px;
        }

        .desktop-sidebar {
            width: 250px;
            background: white;
            height: calc(100vh - 80px);
            position: fixed;
            top: 80px;
            left: 0;
            padding: 20px;
            border-right: 1px solid #eee;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            overflow-y: auto;
        }

        .desktop-sidebar a {
            display: block;
            padding: 12px 10px;
            color: #333;
            text-decoration: none;
            margin-bottom: 8px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .desktop-sidebar a:hover,
        .desktop-sidebar a.active {
            background-color: rgba(255, 88, 158, 0.1);
            color: #ff589e;
        }

        @media (max-width: 991px) {
            .desktop-sidebar {
                display: none;
            }
        }

        @media (min-width: 992px) {
            body {
                padding-left: 270px !important;
            }
        }

        .mobile-bottom-nav {
            display: none;
        }

        @media (max-width: 991px) {
            .mobile-bottom-nav {
                display: flex;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 65px;
                background: white;
                border-top: 1px solid #ddd;
                justify-content: space-around;
                align-items: center;
                z-index: 9999;
                padding-bottom: env(safe-area-inset-bottom);
            }
            .mobile-bottom-nav a {
                text-align: center;
                color: #333;
                font-size: 14px;
                text-decoration: none;
                flex: 1;
                padding: 10px 5px;
            }
            .mobile-bottom-nav i {
                font-size: 20px;
                display: block;
                margin-bottom: 3px;
            }
            .mobile-bottom-nav a.active {
                color: #ff589e;
            }
        }

        body {
            padding-top: 80px;
            background-color: #f8f9fa;
            padding-bottom: 80px;
        }

        .nav-icons {
            display: flex;
            list-style: none;
            gap: 20px;
            align-items: center;
            margin: 0;
            padding: 0;
        }

        .nav-icons a {
            font-size: 20px;
            color: #555;
            transition: 0.2s;
            text-decoration: none;
        }

        .nav-icons a:hover {
            color: #ff589e;
            transform: translateY(-2px);
        }

        .profile-dropdown {
            position: relative;
        }

        .profile-avatar-small {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, #ff589e 0%, #ff136f 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            cursor: pointer;
        }

        .profile-menu {
            position: absolute;
            top: 50px;
            right: 0;
            width: 220px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            padding: 10px 0;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.25s ease;
            z-index: 1000;
        }

        .profile-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0px);
        }

        .profile-menu a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            color: #444;
            text-decoration: none;
            transition: 0.2s;
        }

        .profile-menu a:hover {
            background: #f5f7fa;
            color: #ff589e;
        }

        .profile-divider {
            height: 1px;
            background: #eee;
            margin: 8px 0;
        }

        .three-dot-menu {
            position: relative;
            cursor: pointer;
        }

        .three-dot-menu i {
            font-size: 22px;
            color: #555;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .three-dot-menu i:hover {
            background-color: #f0f0f0;
            color: #ff589e;
        }

        .three-dot-menu .menu-content {
            position: absolute;
            right: 0;
            top: 45px;
            background: #fff;
            width: 200px;
            padding: 8px 0;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .three-dot-menu:hover .menu-content {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .three-dot-menu .menu-content a {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            text-decoration: none;
            color: #444;
            transition: all 0.2s ease;
            border: none;
            background: none;
            width: 100%;
        }

        .three-dot-menu .menu-content a:hover {
            background: rgba(255, 88, 158, 0.1);
            color: #ff589e;
        }

        .three-dot-menu .menu-content a i {
            margin-right: 10px;
            font-size: 16px;
            width: 16px;
            text-align: center;
            padding: 0;
            background: none;
        }

        .preferences-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .preferences-card:hover {
            transform: translateY(-2px);
        }
        .preference-section {
            border-left: 4px solid #007bff;
            padding: 25px;
            margin-bottom: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .preference-item {
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .preference-item:last-child {
            border-bottom: none;
        }
        .form-check-input:checked {
            background-color: #ff589e;
            border-color: #ff589e;
        }
        .form-check-input:focus {
            border-color: #ff589e;
            box-shadow: 0 0 0 0.2rem rgba(255, 88, 158, 0.25);
        }
        .section-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }
        .icon-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }
        .icon-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
        }
        .icon-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: white;
        }
        .icon-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
        }
        
        .user-type-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-left: 10px;
        }
        .badge-applicant {
            background-color: #e8f5e8;
            color: #2e7d32;
        }
        .badge-business {
            background-color: #e3f2fd;
            color: #1565c0;
        }
        
        .business-only {
            display: none;
        }
        .applicant-only {
            display: none;
        }
    </style>
</head>
<body>
    {% load api_utils %}
    {% api_js_functions %}
    <!-- Top Navigation -->
    <header class="header-area">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <nav class="main-nav">
                        <a href="/" class="logo">
                            <img src="/static/images/logo.png" alt="JobPortal" style="max-height: 40px;">
                        </a>

                        <!-- Top Right Icons -->
                        <ul class="nav-icons">
                            <li>
                                <a href="/" title="Home">
                                    <i class="fas fa-home"></i>
                                </a>
                            </li>

                            <li>
                                <a href="/#job-listings" title="Browse Jobs">
                                    <i class="fas fa-search"></i>
                                </a>
                            </li>

                            {% if user.is_authenticated %}
                            <li>
                                <a href="/dashboard" title="Dashboard">
                                    <i class="fas fa-th-large"></i>
                                </a>
                            </li>

                            <!-- Profile Dropdown Icon -->
                            <li class="profile-dropdown">
                                <div class="profile-avatar-small" onclick="toggleProfileDropdown()">
                                    {{ user.username|first|upper }}
                                </div>

                                <div class="profile-menu" id="profileMenu">
                                    <a href="/profile/"><i class="fas fa-user"></i> Profile</a>
                                    <a href="/applications/"><i class="fas fa-file-alt"></i> Applications</a>
                                    <div class="profile-divider"></div>

                                    <a href="/alerts/"><i class="fas fa-bell"></i> Alerts</a>
                                    <a href="/preferences/"><i class="fas fa-cog"></i> Preferences</a>

                                    <div class="profile-divider"></div>

                                    <a href="/logout/"><i class="fas fa-sign-out-alt"></i> Logout</a>
                                </div>
                            </li>
                            <li>
                              <a href="/messaging/">
                                <i class="fas fa-comment-dots"></i>
                              </a>
                            </li>  
                            <li>
                                <div class="three-dot-menu">
                                    <i class="bi bi-three-dots-vertical"></i>
                                    <div class="menu-content">
                                        <a href="/profile/skills/"><i class="fas fa-cogs"></i> Skills</a>
                                        <a href="/profile/employment/"><i class="fas fa-briefcase"></i> Employment</a>
                                        <a href="/profile/education/"><i class="fas fa-graduation-cap"></i> Education</a>
                                        <a href="/profile/documents/"><i class="fas fa-file-upload"></i> Documents</a>
                                    </div>
                                </div>
                            </li>

                            {% else %}
                            <li>
                                <a href="#" onclick="showLogin()" title="Login">
                                    <i class="fas fa-sign-in-alt"></i>
                                </a>
                            </li>

                            <li>
                                <a href="#" onclick="showSignup()" title="Sign Up">
                                    <i class="fas fa-user-plus"></i>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </header>

    <!-- Desktop Sidebar -->
    <div class="desktop-sidebar">
        <a href="/profile/"><i class="fas fa-user"></i> My Profile</a>
        <a href="/applications/"><i class="fas fa-file-alt"></i> Applications</a>
        <a href="/profile/skills/"><i class="fas fa-cogs"></i> Skills</a>
        <a href="/profile/education/"><i class="fas fa-graduation-cap"></i> Education</a>
        <a href="/profile/employment/"><i class="fas fa-briefcase"></i> Employment</a>
        <a href="/profile/documents/"><i class="fas fa-file-upload"></i> Documents</a>
        <a href="/alerts/"><i class="fas fa-bell"></i> Alerts</a>
        <a href="/preferences/" class="active"><i class="fas fa-cog"></i> Preferences</a>
    </div>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1><i class="fas fa-cog me-2 text-primary"></i>Notification Preferences</h1>
                        <p class="text-muted mb-0" id="userTypeIndicator">
                            Loading your preferences...
                        </p>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary btn-sm" onclick="resetToDefaults()">
                            <i class="fas fa-undo me-1"></i>Reset to Defaults
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="savePreferences()">
                            <i class="fas fa-save me-1"></i>Save Changes
                        </button>
                    </div>
                </div>

                <p class="text-muted mb-4" id="preferencesDescription">
                    Manage how and when you receive notifications from JobPortal.
                </p>

                <!-- Notification Channels - FOR BOTH USER TYPES -->
                <div class="card preferences-card mb-4">
                    <div class="card-header bg-transparent">
                        <div class="d-flex align-items-center">
                            <div class="section-icon icon-primary">
                                <i class="fas fa-bell"></i>
                            </div>
                            <div>
                                <h5 class="mb-1">Notification Channels</h5>
                                <p class="text-muted mb-0">Choose how you want to receive notifications</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="preference-section">
                            <div class="preference-item">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="emailNotifications">
                                    <label class="form-check-label" for="emailNotifications">
                                        <strong>Email Notifications</strong>
                                        <p class="text-muted mb-0 small">Receive notifications via email</p>
                                    </label>
                                </div>
                            </div>
                            <div class="preference-item">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="inAppNotifications">
                                    <label class="form-check-label" for="inAppNotifications">
                                        <strong>In-App Notifications</strong>
                                        <p class="text-muted mb-0 small">See notifications when you're logged in</p>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FOR APPLICANTS ONLY -->
                <div class="card preferences-card mb-4 applicant-only">
                    <div class="card-header bg-transparent">
                        <div class="d-flex align-items-center">
                            <div class="section-icon icon-success">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <div>
                                <h5 class="mb-1">Application Updates</h5>
                                <p class="text-muted mb-0">Stay informed about your job applications</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="preference-section">
                            <div class="preference-item">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="applicationUpdates">
                                    <label class="form-check-label" for="applicationUpdates">
                                        <strong>Application Status Changes</strong>
                                        <p class="text-muted mb-0 small">Get notified when your application status changes</p>
                                    </label>
                                </div>
                            </div>
                            <div class="preference-item">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="interviewInvites">
                                    <label class="form-check-label" for="interviewInvites">
                                        <strong>Interview Invitations</strong>
                                        <p class="text-muted mb-0 small">Receive notifications for interview requests</p>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FOR APPLICANTS ONLY -->
                <div class="card preferences-card mb-4 applicant-only">
                    <div class="card-header bg-transparent">
                        <div class="d-flex align-items-center">
                            <div class="section-icon icon-warning">
                                <i class="fas fa-briefcase"></i>
                            </div>
                            <div>
                                <h5 class="mb-1">Job Alerts</h5>
                                <p class="text-muted mb-0">Get notified about new job opportunities</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="preference-section">
                            <div class="preference-item">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="jobAlerts">
                                    <label class="form-check-label" for="jobAlerts">
                                        <strong>Matching Job Opportunities</strong>
                                        <p class="text-muted mb-0 small">Receive alerts for jobs matching your profile</p>
                                    </label>
                                </div>
                            </div>
                            <div class="preference-item">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="savedSearchAlerts">
                                    <label class="form-check-label" for="savedSearchAlerts">
                                        <strong>Saved Search Alerts</strong>
                                        <p class="text-muted mb-0 small">Get notified when new jobs match your saved searches</p>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FOR BUSINESS USERS ONLY -->
                <div class="card preferences-card mb-4 business-only">
                    <div class="card-header bg-transparent">
                        <div class="d-flex align-items-center">
                            <div class="section-icon icon-success">
                                <i class="fas fa-users"></i>
                            </div>
                            <div>
                                <h5 class="mb-1">Candidate & Application Alerts</h5>
                                <p class="text-muted mb-0">Stay updated on your job postings and candidates</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="preference-section">
                            <div class="preference-item">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="newApplications">
                                    <label class="form-check-label" for="newApplications">
                                        <strong>New Applications</strong>
                                        <p class="text-muted mb-0 small">Get notified when someone applies to your jobs</p>
                                    </label>
                                </div>
                            </div>
                            <div class="preference-item">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="jobExpiryAlerts">
                                    <label class="form-check-label" for="jobExpiryAlerts">
                                        <strong>Job Expiry Alerts</strong>
                                        <p class="text-muted mb-0 small">Receive alerts when your job postings are about to expire</p>
                                    </label>
                                </div>
                            </div>
                            <div class="preference-item">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="candidateUpdates">
                                    <label class="form-check-label" for="candidateUpdates">
                                        <strong>Candidate Profile Updates</strong>
                                        <p class="text-muted mb-0 small">Get notified when applicants update their profiles</p>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FOR BOTH USER TYPES -->
                <div class="card preferences-card mb-4">
                    <div class="card-header bg-transparent">
                        <div class="d-flex align-items-center">
                            <div class="section-icon icon-info">
                                <i class="fas fa-user"></i>
                            </div>
                            <div>
                                <h5 class="mb-1">Profile & Account</h5>
                                <p class="text-muted mb-0">Notifications about your profile and account</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="preference-section">
                            <div class="preference-item">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="profileReminders">
                                    <label class="form-check-label" for="profileReminders">
                                        <strong>Profile Completion Reminders</strong>
                                        <p class="text-muted mb-0 small">Get reminders to complete your profile</p>
                                    </label>
                                </div>
                            </div>
                            <div class="preference-item">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="accountSecurity">
                                    <label class="form-check-label" for="accountSecurity">
                                        <strong>Account Security Alerts</strong>
                                        <p class="text-muted mb-0 small">Important notifications about your account security</p>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FOR BOTH USER TYPES -->
                <div class="card preferences-card mb-4">
                    <div class="card-header bg-transparent">
                        <div class="d-flex align-items-center">
                            <div class="section-icon" style="background: linear-gradient(135deg, #6f42c1 0%, #563d7c 100%); color: white;">
                                <i class="fas fa-bullhorn"></i>
                            </div>
                            <div>
                                <h5 class="mb-1">Marketing & Promotional</h5>
                                <p class="text-muted mb-0">Optional communications from JobPortal</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="preference-section">
                            <div class="preference-item">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="marketingEmails">
                                    <label class="form-check-label" for="marketingEmails">
                                        <strong>Marketing Emails</strong>
                                        <p class="text-muted mb-0 small">Receive promotional emails and special offers</p>
                                    </label>
                                </div>
                            </div>
                            <div class="preference-item">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="systemMaintenance">
                                    <label class="form-check-label" for="systemMaintenance">
                                        <strong>System Maintenance Alerts</strong>
                                        <p class="text-muted mb-0 small">Notifications about platform maintenance and updates</p>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Save Button -->
                <div class="text-center mt-4">
                    <button class="btn btn-primary btn-lg" onclick="savePreferences()">
                        <i class="fas fa-save me-2"></i>Save All Preferences
                    </button>
                    <button class="btn btn-outline-secondary btn-lg ms-2" onclick="resetToDefaults()">
                        <i class="fas fa-undo me-2"></i>Reset to Defaults
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Bottom Navbar -->
    <div class="mobile-bottom-nav">
        <a href="/"><i class="fas fa-home"></i>Home</a>
        <a href="/dashboard"><i class="fas fa-tachometer-alt"></i>Dashboard</a>
        <a href="/applications/"><i class="fas fa-file-alt"></i>Jobs</a>
        <a href="/preferences/" class="active"><i class="fas fa-cog"></i>Prefs</a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentUserType = '';
        let currentPreferences = {};

        // Navigation functions
        function toggleProfileDropdown() {
            document.getElementById("profileMenu").classList.toggle("show");
        }

        document.addEventListener("click", function(e) {
            const menu = document.getElementById("profileMenu");
            const avatar = document.querySelector(".profile-avatar-small");
            if (avatar && menu && !avatar.contains(e.target) && !menu.contains(e.target)) {
                menu.classList.remove("show");
            }
        });

        // Load preferences when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadPreferences();
        });

        async function loadPreferences() {
            try {
                const response = await fetch('/api/notifications/preferences/');
                const data = await response.json();
                
                if (data.success) {
                    currentUserType = data.user_type;
                    currentPreferences = data.preferences;
                    updateUIForUserType();
                    populatePreferencesForm(data.preferences);
                    showToast('Preferences loaded successfully!', 'success');
                } else {
                    throw new Error(data.error || 'Failed to load preferences');
                }
            } catch (error) {
                console.error('Error loading preferences:', error);
                showToast('Error loading preferences. Using defaults.', 'error');
                loadDefaultPreferences();
            }
        }

        function updateUIForUserType() {
            const userTypeIndicator = document.getElementById('userTypeIndicator');
            const description = document.getElementById('preferencesDescription');
            
            if (currentUserType === 'applicant') {
                userTypeIndicator.innerHTML = 'Applicant Account <span class="user-type-badge badge-applicant">Applicant</span>';
                description.textContent = 'Manage how and when you receive notifications about your job applications and opportunities.';
                
                // Show applicant sections, hide business sections
                document.querySelectorAll('.applicant-only').forEach(el => el.style.display = 'block');
                document.querySelectorAll('.business-only').forEach(el => el.style.display = 'none');
                
            } else if (currentUserType === 'business') {
                userTypeIndicator.innerHTML = 'Business Account <span class="user-type-badge badge-business">Business</span>';
                description.textContent = 'Manage how and when you receive notifications about your job postings and candidates.';
                
                // Show business sections, hide applicant sections
                document.querySelectorAll('.business-only').forEach(el => el.style.display = 'block');
                document.querySelectorAll('.applicant-only').forEach(el => el.style.display = 'none');
            }
        }

        function populatePreferencesForm(preferences) {
            // Common preferences for both user types
            document.getElementById('emailNotifications').checked = preferences.email_notifications !== false;
            document.getElementById('inAppNotifications').checked = preferences.in_app_notifications !== false;
            document.getElementById('profileReminders').checked = preferences.profile_reminders !== false;
            document.getElementById('accountSecurity').checked = preferences.account_security !== false;
            document.getElementById('marketingEmails').checked = preferences.marketing_emails || false;
            document.getElementById('systemMaintenance').checked = preferences.system_maintenance !== false;

            if (currentUserType === 'applicant') {
                // Applicant-specific preferences
                document.getElementById('applicationUpdates').checked = preferences.application_updates !== false;
                document.getElementById('interviewInvites').checked = preferences.interview_invites !== false;
                document.getElementById('jobAlerts').checked = preferences.job_alerts !== false;
                document.getElementById('savedSearchAlerts').checked = preferences.saved_search_alerts !== false;
            } else if (currentUserType === 'business') {
                // Business-specific preferences
                document.getElementById('newApplications').checked = preferences.new_applications !== false;
                document.getElementById('jobExpiryAlerts').checked = preferences.job_expiry_alerts !== false;
                document.getElementById('candidateUpdates').checked = preferences.candidate_updates !== false;
            }
        }

        function getFormData() {
            const baseData = {
                email_notifications: document.getElementById('emailNotifications').checked,
                in_app_notifications: document.getElementById('inAppNotifications').checked,
                profile_reminders: document.getElementById('profileReminders').checked,
                account_security: document.getElementById('accountSecurity').checked,
                marketing_emails: document.getElementById('marketingEmails').checked,
                system_maintenance: document.getElementById('systemMaintenance').checked
            };

            if (currentUserType === 'applicant') {
                baseData.application_updates = document.getElementById('applicationUpdates').checked;
                baseData.interview_invites = document.getElementById('interviewInvites').checked;
                baseData.job_alerts = document.getElementById('jobAlerts').checked;
                baseData.saved_search_alerts = document.getElementById('savedSearchAlerts').checked;
            } else if (currentUserType === 'business') {
                baseData.new_applications = document.getElementById('newApplications').checked;
                baseData.job_expiry_alerts = document.getElementById('jobExpiryAlerts').checked;
                baseData.candidate_updates = document.getElementById('candidateUpdates').checked;
            }

            return baseData;
        }

        function loadDefaultPreferences() {
            // Set all checkboxes to true by default
            const checkboxes = document.querySelectorAll('.form-check-input');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
        }

        async function savePreferences() {
            const formData = getFormData();
            
            try {
                const response = await fetch('/api/notifications/preferences/', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Preferences saved successfully!', 'success');
                    currentPreferences = data.preferences || formData;
                } else {
                    showToast('Error saving preferences: ' + (data.error || 'Please try again'), 'error');
                }
            } catch (error) {
                console.error('Error saving preferences:', error);
                showToast('Error saving preferences. Please try again.', 'error');
            }
        }

        function resetToDefaults() {
            if (confirm('Are you sure you want to reset all preferences to their default values?')) {
                loadDefaultPreferences();
                showToast('Preferences reset to defaults', 'info');
            }
        }

        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0 position-fixed top-0 end-0 m-3`;
            toast.style.zIndex = '9999';
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            document.body.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', () => {
                document.body.removeChild(toast);
            });
        }

        function getCSRFToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>